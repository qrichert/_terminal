var Terminal=function(a){this.m_parent=a;this.m_historyNext=this.m_historyPrevious=this.m_history=this.m_editorSaveWaitingForResponse=this.m_editorSave=this.m_editorCancel=this.m_editorFilename=this.m_editorInterface=this.m_editorTextArea=this.m_editor=this.m_input=this.m_promptCommand=this.m_promptInfoWaitingForResponse=this.m_promptInfoWaitingForCommand=this.m_promptInfoPath=this.m_promptInfoSeparator=this.m_promptInfoUser=this.m_promptInfo=this.m_prompt=this.m_output=null;this.m_apiUrl=this.m_parent.dataset.action||
location.href;this.m_isWaitingForResponse=!1;this.m_isWaitingForResponseIntervalHandle=null;this.Mode={COMMAND:"command",EDITOR:"editor",PASSWORD:"password"};this.m_mode=this.Mode.COMMAND;this.m_editorCurrentFileData=null;this.m_commandHistory=[];this.m_commandHistoryIndex=this.m_commandHistoryCount=0;this.buildTerminalView();this.addListeners();this.ehlo();this.m_input.focus()};
Terminal.prototype.buildTerminalView=function(){var a=this;this.m_parent.classList.add("terminal");var c=document.createDocumentFragment();this.m_output=document.createElement("div");this.m_output.classList.add("terminal__output");c.appendChild(this.m_output);this.m_prompt=document.createElement("div");this.m_prompt.classList.add("terminal__prompt");c.appendChild(this.m_prompt);this.m_promptInfo=document.createElement("div");this.m_promptInfo.classList.add("terminal__prompt--info");this.m_prompt.appendChild(this.m_promptInfo);
this.m_promptInfoUser=document.createElement("span");this.m_promptInfoUser.classList.add("user");this.m_promptInfo.appendChild(this.m_promptInfoUser);this.m_promptInfoSeparator=document.createElement("span");this.m_promptInfoSeparator.classList.add("separator");this.m_promptInfo.appendChild(this.m_promptInfoSeparator);this.m_promptInfoPath=document.createElement("span");this.m_promptInfoPath.classList.add("path");this.m_promptInfo.appendChild(this.m_promptInfoPath);this.m_promptInfoWaitingForCommand=
document.createElement("span");this.m_promptInfoWaitingForCommand.classList.add("waiting-for-command");this.m_promptInfoWaitingForCommand.textContent="$";this.m_promptInfo.appendChild(this.m_promptInfoWaitingForCommand);this.m_promptInfoWaitingForResponse=document.createElement("span");this.m_promptInfoWaitingForResponse.classList.add("waiting-for-response");this.m_promptInfoWaitingForResponse.textContent="";this.m_promptInfo.appendChild(this.m_promptInfoWaitingForResponse);this.m_promptInfo.appendChild(document.createTextNode(String.fromCharCode(160)));
this.m_promptCommand=document.createElement("div");this.m_promptCommand.classList.add("terminal__prompt--command");this.m_prompt.appendChild(this.m_promptCommand);this.m_input=document.createElement("input");this.m_input.autocapitalize="off";this.m_input.spellcheck="false";this.m_input.style.visibility="hidden";this.m_input.addEventListener("keydown",function(c){a.inputKeyEvent(c)},!1);this.m_promptCommand.appendChild(this.m_input);this.m_editor=document.createElement("div");this.m_editor.classList.add("terminal__editor");
c.appendChild(this.m_editor);this.m_editorTextArea=document.createElement("textarea");this.m_editorTextArea.classList.add("terminal__editor--textarea");this.m_editor.appendChild(this.m_editorTextArea);this.m_editorInterface=document.createElement("div");this.m_editorInterface.classList.add("terminal__editor--interface");this.m_editor.appendChild(this.m_editorInterface);this.m_editorFilename=document.createElement("p");this.m_editorFilename.classList.add("filename");this.m_editorFilename.textContent=
"";this.m_editorInterface.appendChild(this.m_editorFilename);this.m_editorCancel=document.createElement("a");this.m_editorCancel.classList.add("cancel");this.m_editorCancel.textContent="[Cancel]";this.m_editorInterface.appendChild(this.m_editorCancel);this.m_editorSave=document.createElement("a");this.m_editorSave.classList.add("save");this.m_editorInterface.appendChild(this.m_editorSave);this.m_editorSave.appendChild(document.createTextNode("[Save"));this.m_editorSaveWaitingForResponse=document.createElement("span");
this.m_editorSaveWaitingForResponse.textContent="";this.m_editorSave.appendChild(this.m_editorSaveWaitingForResponse);this.m_editorSave.appendChild(document.createTextNode("]"));this.m_history=document.createElement("div");this.m_history.classList.add("terminal__history");this.m_history.classList.add("hidden");c.appendChild(this.m_history);this.m_historyPrevious=document.createElement("a");this.m_historyPrevious.classList.add("previous");this.m_historyPrevious.textContent="[\u2b06]";this.m_history.appendChild(this.m_historyPrevious);
this.m_historyNext=document.createElement("a");this.m_historyNext.classList.add("next");this.m_historyNext.textContent="[\u2b07]";this.m_history.appendChild(this.m_historyNext);this.m_parent.appendChild(c)};
Terminal.prototype.addListeners=function(){var a=this;window.addEventListener("load",function(){a.restoreCommandHistory()},!1);window.addEventListener("unload",function(){a.saveCommandHistory()},!1);this.m_editorCancel.addEventListener("click",function(c){c.preventDefault();a.editorCancel()},!1);this.m_editorSave.addEventListener("click",function(c){c.preventDefault();a.editorSave()},!1);this.m_historyPrevious.addEventListener("click",function(c){c.preventDefault();a.commandHistoryPrevious()},!1);
this.m_historyNext.addEventListener("click",function(c){c.preventDefault();a.commandHistoryNext()},!1)};Terminal.prototype.inputKeyEvent=function(a){"Enter"===a.key?this.command():"ArrowUp"===a.key?this.commandHistoryPrevious():"ArrowDown"===a.key&&this.commandHistoryNext()};Terminal.prototype.saveCommandHistory=function(){localStorage.setItem("_terminal--command-history",JSON.stringify(this.m_commandHistory))};
Terminal.prototype.restoreCommandHistory=function(){this.m_commandHistory=[];try{var a=JSON.parse(localStorage.getItem("_terminal--command-history"));Array.isArray(a)&&(this.m_commandHistory=a)}catch(c){}this.m_commandHistoryIndex=this.m_commandHistoryCount=this.m_commandHistory.length};
Terminal.prototype.commandHistoryAppend=function(a){""!==a&&a!==this.m_commandHistory[this.m_commandHistoryCount-1]&&(this.m_commandHistory.push(a),this.m_commandHistoryCount=this.m_commandHistory.length,100<this.m_commandHistoryCount&&(a=this.m_commandHistoryCount-100,this.m_commandHistoryCount=100,this.m_commandHistory.splice(0,a)));this.m_commandHistoryIndex=this.m_commandHistoryCount};
Terminal.prototype.commandHistoryPrevious=function(){this.m_mode===this.Mode.COMMAND&&0!==this.m_commandHistoryCount&&(this.m_commandHistoryIndex--,0>this.m_commandHistoryIndex&&(this.m_commandHistoryIndex=0),this.m_input.value=this.m_commandHistory[this.m_commandHistoryIndex])};
Terminal.prototype.commandHistoryNext=function(){this.m_mode===this.Mode.COMMAND&&0!==this.m_commandHistoryCount&&(this.m_commandHistoryIndex++,this.m_commandHistoryIndex>=this.m_commandHistoryCount?(this.m_commandHistoryIndex=this.m_commandHistoryCount,this.m_input.value=""):this.m_input.value=this.m_commandHistory[this.m_commandHistoryIndex])};
Terminal.prototype.switchToCommandInterface=function(){this.m_mode=this.Mode.COMMAND;this.m_input.type="text";this.m_input.name="terminal[command]";this.m_editor.classList.remove("shown");this.m_history.classList.remove("hidden");this.m_input.focus()};Terminal.prototype.switchToEditorInterface=function(){this.m_mode=this.Mode.EDITOR;this.m_editor.classList.add("shown");this.m_history.classList.add("hidden");this.m_editorTextArea.focus()};
Terminal.prototype.switchToPasswordInterface=function(){this.m_mode=this.Mode.PASSWORD;this.m_input.type="password";this.m_input.name="terminal[password]";this.m_editor.classList.remove("shown");this.m_history.classList.add("hidden");this.m_input.focus()};
Terminal.prototype.startWaitingForResponse=function(){var a=this,c=["/","\u2014","\\","|"],e=0,b=c.length;this.m_promptInfoWaitingForResponse.textContent=c[e];this.m_editorSaveWaitingForResponse.textContent=c[e];this.m_isWaitingForResponse=!0;this.m_isWaitingForResponseIntervalHandle=setInterval(function(){e++;e>b-1&&(e=0);a.m_promptInfoWaitingForResponse.textContent=c[e];a.m_editorSaveWaitingForResponse.textContent=c[e]},135);this.m_promptInfoWaitingForCommand.style.display="none";this.m_promptInfoWaitingForResponse.style.display=
"inline";this.m_input.disabled=!0;this.m_editorTextArea.disabled=!0;this.m_editorCancel.style.visibility="hidden"};Terminal.prototype.stopWaitingForResponse=function(){this.m_promptInfoWaitingForCommand.style.display="inline";this.m_promptInfoWaitingForResponse.style.display="none";this.m_input.disabled=!1;this.m_input.value="";this.m_editorSaveWaitingForResponse.textContent="";this.m_editorTextArea.disabled=!1;this.m_editorCancel.style.visibility=null;this.m_isWaitingForResponse=!1;clearInterval(this.m_isWaitingForResponseIntervalHandle)};
Terminal.prototype.printOutput=function(a,c){c=void 0===c?null:c;var e=document.createDocumentFragment();if("string"===typeof c||c instanceof String){var b=document.createElement("div");b.classList.add("terminal__prompt--info");e.appendChild(b);var d=this.m_promptInfoUser.cloneNode(!0);b.appendChild(d);d=this.m_promptInfoSeparator.cloneNode(!0);b.appendChild(d);d=this.m_promptInfoPath.cloneNode(!0);b.appendChild(d);d=this.m_promptInfoWaitingForCommand.cloneNode(!0);d.style.display="inline";b.appendChild(d);
b.appendChild(document.createTextNode(String.fromCharCode(160)));d=document.createElement("span");d.textContent=c;b.appendChild(d)}b=document.createElement("pre");b.innerHTML=a;e.appendChild(b);this.m_output.appendChild(e)};Terminal.prototype.clearOutput=function(){this.m_output.textContent=""};Terminal.prototype.setPromptInfo=function(a,c){this.m_promptInfoUser.textContent=a;this.m_promptInfoSeparator.textContent=":";this.m_promptInfoPath.textContent=c};
Terminal.prototype.clearPromptInfo=function(){this.m_promptInfoUser.textContent="";this.m_promptInfoSeparator.textContent="";this.m_promptInfoPath.textContent=""};
Terminal.prototype.ehlo=function(){var a=this,c=new FormData;c.append("request","ehlo");var e=function(){a.stopWaitingForResponse();a.m_input.focus()};this.startWaitingForResponse();SimpleRequest.post(this.m_apiUrl,c,function(b){null!==b&&"ERROR"!==b.status&&"undefined"!==typeof b.response&&null!==b.response&&(a.m_input.style.visibility="visible","ready"===b.response?(a.setPromptInfo(b.user,b.path),a.switchToCommandInterface()):a.switchToPasswordInterface(),"undefined"!==typeof b.output&&null!==b.output&&
a.printOutput(b.output));a.stopWaitingForResponse();a.m_input.focus()},e,e,null,{get_json:!0})};
Terminal.prototype.logIn=function(){var a=this,c=new FormData;c.append("request","log-in");c.append("password",this.m_input.value);var e=function(b){b=void 0===b?null:b;null!==b&&"undefined"!==typeof b.output&&null!==b.output?a.printOutput(b.output):("string"===typeof b||b instanceof String)&&a.printOutput(b);a.stopWaitingForResponse();a.m_input.focus()};this.startWaitingForResponse();SimpleRequest.post(this.m_apiUrl,c,function(b){null===b||"ERROR"===b.status?e(b):"undefined"===typeof b.response||
null===b.response?e(b):"ready"===b.response?(a.clearOutput(),a.setPromptInfo(b.user,b.path),a.switchToCommandInterface(),"undefined"!==typeof b.output&&null!==b.output&&a.printOutput(b.output),a.stopWaitingForResponse(),a.m_input.focus()):e(b)},e,e,null,{get_json:!0})};
Terminal.prototype.command=function(){var a=this;if(!this.m_isWaitingForResponse)if(this.m_mode===this.Mode.PASSWORD)this.logIn();else{var c=this.m_input.value.trim();this.commandHistoryAppend(c);if("clear"===c)this.clearOutput(),this.stopWaitingForResponse();else{var e=new FormData;e.append("request","command");e.append("command",c);var b=function(b){b=void 0===b?null:b;null!==b&&"undefined"!==typeof b.output&&null!==b.output?a.printOutput(b.output):("string"===typeof b||b instanceof String)&&a.printOutput(b);
a.stopWaitingForResponse();a.m_input.focus()};this.startWaitingForResponse();SimpleRequest.post(this.m_apiUrl,e,function(d){null===d||"ERROR"===d.status?b(d):"undefined"===typeof d.response||null===d.response?b(d):("undefined"!==typeof d.output&&null!==d.output&&a.printOutput(d.output,c),"undefined"!==typeof d.path&&null!==d.path&&(a.m_promptInfoPath.textContent=d.path),"require-exit"===d.response?(a.clearPromptInfo(),a.switchToPasswordInterface()):"require-editor"===d.response&&(a.m_editorCurrentFileData=
{file:"",filename:"",new_file:!1,content:""},"undefined"!==typeof d.file&&null!==d.file&&(a.m_editorCurrentFileData.file=d.file),"undefined"!==typeof d.filename&&null!==d.filename&&(a.m_editorCurrentFileData.filename=d.filename),"boolean"===typeof d.new_file&&(a.m_editorCurrentFileData.new_file=d.new_file),"undefined"!==typeof d.content&&null!==d.content&&(a.m_editorCurrentFileData.content=d.content),a.m_editorTextArea.value=a.m_editorCurrentFileData.content,a.m_editorFilename.textContent='"'+a.m_editorCurrentFileData.filename+
'"'+(a.m_editorCurrentFileData.new_file?" [New File]":""),a.switchToEditorInterface()),a.stopWaitingForResponse(),a.m_input.focus())},b,b,null,{get_json:!0})}}};Terminal.prototype.editorCancel=function(){this.switchToCommandInterface();this.m_editorCurrentFileData=null};
Terminal.prototype.editorSave=function(){var a=this;if(!this.m_isWaitingForResponse&&this.m_mode===this.Mode.EDITOR){var c=new FormData;c.append("request","save-file");c.append("file",this.m_editorCurrentFileData.file);c.append("content",this.m_editorTextArea.value);var e=function(b){alert("[Error] Could not save file.");a.stopWaitingForResponse()};this.startWaitingForResponse();SimpleRequest.post(this.m_apiUrl,c,function(b){null===b||"ERROR"===b.status?e(b):"undefined"===typeof b.response||null===
b.response?e(b):(a.switchToCommandInterface(),a.m_editorCurrentFileData=null,a.m_editorTextArea.value="",a.stopWaitingForResponse())},e,e,null,{get_json:!0})}};

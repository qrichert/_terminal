var Terminal=function(b){this.m_parent=b;this.m_editorCancel=this.m_editorSave=this.m_editorFilename=this.m_editorInterface=this.m_editorTextArea=this.m_editor=this.m_input=this.m_promptCommand=this.m_promptInfoWaitingForResponse=this.m_promptInfoWaitingForCommand=this.m_promptInfoPath=this.m_promptInfoSeparator=this.m_promptInfoUser=this.m_promptInfo=this.m_prompt=this.m_output=null;this.m_apiUrl=this.m_parent.dataset.action||location.href;this.m_isWaitingForResponse=!1;this.m_isWaitingForResponseIntervalHandle=
null;this.Mode={COMMAND:"command",EDITOR:"editor",PASSWORD:"password"};this.m_mode=this.Mode.COMMAND;this.m_commandHistory=[];this.m_commandHistoryIndex=this.m_commandHistoryCount=0;this.buildTerminalView();this.ehlo();this.m_input.focus()};
Terminal.prototype.buildTerminalView=function(){var b=this;this.m_parent.classList.add("terminal");var c=document.createDocumentFragment();this.m_output=document.createElement("div");this.m_output.classList.add("terminal__output");c.appendChild(this.m_output);this.m_prompt=document.createElement("div");this.m_prompt.classList.add("terminal__prompt");c.appendChild(this.m_prompt);this.m_promptInfo=document.createElement("div");this.m_promptInfo.classList.add("terminal__prompt--info");this.m_prompt.appendChild(this.m_promptInfo);
this.m_promptInfoUser=document.createElement("span");this.m_promptInfoUser.classList.add("user");this.m_promptInfo.appendChild(this.m_promptInfoUser);this.m_promptInfoSeparator=document.createElement("span");this.m_promptInfoSeparator.classList.add("separator");this.m_promptInfo.appendChild(this.m_promptInfoSeparator);this.m_promptInfoPath=document.createElement("span");this.m_promptInfoPath.classList.add("path");this.m_promptInfo.appendChild(this.m_promptInfoPath);this.m_promptInfoWaitingForCommand=
document.createElement("span");this.m_promptInfoWaitingForCommand.classList.add("waiting-for-command");this.m_promptInfoWaitingForCommand.textContent="$";this.m_promptInfo.appendChild(this.m_promptInfoWaitingForCommand);this.m_promptInfoWaitingForResponse=document.createElement("span");this.m_promptInfoWaitingForResponse.classList.add("waiting-for-response");this.m_promptInfoWaitingForResponse.textContent="";this.m_promptInfo.appendChild(this.m_promptInfoWaitingForResponse);this.m_promptInfo.appendChild(document.createTextNode(String.fromCharCode(160)));
this.m_promptCommand=document.createElement("div");this.m_promptCommand.classList.add("terminal__prompt--command");this.m_prompt.appendChild(this.m_promptCommand);this.m_input=document.createElement("input");this.m_input.autocapitalize="off";this.m_input.spellcheck="false";this.m_input.style.visibility="hidden";this.m_input.addEventListener("keydown",function(c){b.inputKeyEvent(c)},!1);this.m_promptCommand.appendChild(this.m_input);this.m_editor=document.createElement("div");this.m_editor.classList.add("terminal__editor");
c.appendChild(this.m_editor);this.m_editorTextArea=document.createElement("textarea");this.m_editorTextArea.classList.add("terminal__editor--textarea");this.m_editor.appendChild(this.m_editorTextArea);this.m_editorInterface=document.createElement("div");this.m_editorInterface.classList.add("terminal__editor--interface");this.m_editor.appendChild(this.m_editorInterface);this.m_editorFilename=document.createElement("p");this.m_editorFilename.classList.add("filename");this.m_editorFilename.textContent=
"";this.m_editorInterface.appendChild(this.m_editorFilename);this.m_editorSave=document.createElement("a");this.m_editorSave.classList.add("save");this.m_editorSave.textContent="[Save]";this.m_editorInterface.appendChild(this.m_editorSave);this.m_editorCancel=document.createElement("a");this.m_editorCancel.classList.add("cancel");this.m_editorCancel.textContent="[Cancel]";this.m_editorInterface.appendChild(this.m_editorCancel);this.m_parent.appendChild(c)};
Terminal.prototype.inputKeyEvent=function(b){"Enter"===b.key?this.command():"ArrowUp"===b.key?this.commandHistoryPrevious():"ArrowDown"===b.key&&this.commandHistoryNext()};Terminal.prototype.commandHistoryAppend=function(b){b!==this.m_commandHistory[this.m_commandHistoryCount-1]&&(this.m_commandHistory.push(b),this.m_commandHistoryIndex=this.m_commandHistoryCount=this.m_commandHistory.length)};
Terminal.prototype.commandHistoryPrevious=function(){this.m_mode===this.Mode.COMMAND&&0!==this.m_commandHistoryCount&&(this.m_commandHistoryIndex--,0>this.m_commandHistoryIndex&&(this.m_commandHistoryIndex=0),this.m_input.value=this.m_commandHistory[this.m_commandHistoryIndex])};
Terminal.prototype.commandHistoryNext=function(){this.m_mode===this.Mode.COMMAND&&0!==this.m_commandHistoryCount&&(this.m_commandHistoryIndex++,this.m_commandHistoryIndex>=this.m_commandHistoryCount?(this.m_commandHistoryIndex=this.m_commandHistoryCount,this.m_input.value=""):this.m_input.value=this.m_commandHistory[this.m_commandHistoryIndex])};Terminal.prototype.switchToCommandInterface=function(){this.m_mode=this.Mode.COMMAND;this.m_input.type="text";this.m_input.name="terminal[command]"};
Terminal.prototype.switchToEditorInterface=function(){this.m_mode=this.Mode.EDITOR};Terminal.prototype.switchToPasswordInterface=function(){this.m_mode=this.Mode.PASSWORD;this.m_input.type="password";this.m_input.name="terminal[password]"};
Terminal.prototype.startWaitingForResponse=function(){var b=this,c=["/","\u2014","\\","|"],e=0,a=c.length;this.m_promptInfoWaitingForResponse.textContent=c[e];this.m_isWaitingForResponse=!0;this.m_isWaitingForResponseIntervalHandle=setInterval(function(){e++;e>a-1&&(e=0);b.m_promptInfoWaitingForResponse.textContent=c[e]},135);this.m_promptInfoWaitingForCommand.style.display="none";this.m_promptInfoWaitingForResponse.style.display="inline";this.m_input.disabled=!0};
Terminal.prototype.stopWaitingForResponse=function(){this.m_promptInfoWaitingForCommand.style.display="inline";this.m_promptInfoWaitingForResponse.style.display="none";this.m_input.disabled=!1;this.m_input.value="";this.m_isWaitingForResponse=!1;clearInterval(this.m_isWaitingForResponseIntervalHandle)};
Terminal.prototype.printOutput=function(b,c){c=void 0===c?null:c;var e=document.createDocumentFragment();if("string"===typeof c||c instanceof String){var a=document.createElement("div");a.classList.add("terminal__prompt--info");e.appendChild(a);var d=this.m_promptInfoUser.cloneNode(!0);a.appendChild(d);d=this.m_promptInfoSeparator.cloneNode(!0);a.appendChild(d);d=this.m_promptInfoPath.cloneNode(!0);a.appendChild(d);d=this.m_promptInfoWaitingForCommand.cloneNode(!0);d.style.display="inline";a.appendChild(d);
a.appendChild(document.createTextNode(String.fromCharCode(160)));d=document.createElement("span");d.textContent=c;a.appendChild(d)}a=document.createElement("pre");a.innerHTML=b;e.appendChild(a);this.m_output.appendChild(e)};Terminal.prototype.clearOutput=function(){this.m_output.textContent=""};Terminal.prototype.setPromptInfo=function(b,c){this.m_promptInfoUser.textContent=b;this.m_promptInfoSeparator.textContent=":";this.m_promptInfoPath.textContent=c};
Terminal.prototype.clearPromptInfo=function(){this.m_promptInfoUser.textContent="";this.m_promptInfoSeparator.textContent="";this.m_promptInfoPath.textContent=""};
Terminal.prototype.ehlo=function(){var b=this,c=new FormData;c.append("request","ehlo");var e=function(){b.stopWaitingForResponse();b.m_input.focus()};this.startWaitingForResponse();SimpleRequest.post(this.m_apiUrl,c,function(a){null!==a&&"ERROR"!==a.status&&"undefined"!==typeof a.response&&null!==a.response&&(b.m_input.style.visibility="visible","ready"===a.response?(b.setPromptInfo(a.user,a.path),b.switchToCommandInterface()):b.switchToPasswordInterface(),"undefined"!==typeof a.output&&null!==a.output&&
b.printOutput(a.output));b.stopWaitingForResponse();b.m_input.focus()},e,e,null,{get_json:!0})};
Terminal.prototype.logIn=function(){var b=this,c=new FormData;c.append("request","log-in");c.append("password",this.m_input.value);var e=function(a){a=void 0===a?null:a;null!==a&&"undefined"!==typeof a.output&&null!==a.output?b.printOutput(a.output):("string"===typeof a||a instanceof String)&&b.printOutput(a);b.stopWaitingForResponse();b.m_input.focus()};this.startWaitingForResponse();SimpleRequest.post(this.m_apiUrl,c,function(a){null===a||"ERROR"===a.status?e(a):"undefined"===typeof a.response||
null===a.response?e(a):"ready"===a.response?(b.clearOutput(),b.setPromptInfo(a.user,a.path),b.switchToCommandInterface(),"undefined"!==typeof a.output&&null!==a.output&&b.printOutput(a.output),b.stopWaitingForResponse(),b.m_input.focus()):e(a)},e,e,null,{get_json:!0})};
Terminal.prototype.command=function(){var b=this;if(!this.m_isWaitingForResponse)if(this.m_mode===this.Mode.PASSWORD)this.logIn();else{var c=this.m_input.value.trim();this.commandHistoryAppend(c);if("clear"===c)this.clearOutput(),this.stopWaitingForResponse();else{var e=new FormData;e.append("request","command");e.append("command",c);var a=function(a){a=void 0===a?null:a;null!==a&&"undefined"!==typeof a.output&&null!==a.output?b.printOutput(a.output):("string"===typeof a||a instanceof String)&&b.printOutput(a);
b.stopWaitingForResponse();b.m_input.focus()};this.startWaitingForResponse();SimpleRequest.post(this.m_apiUrl,e,function(d){null===d||"ERROR"===d.status?a(d):"undefined"===typeof d.response||null===d.response?a(d):("undefined"!==typeof d.output&&null!==d.output&&b.printOutput(d.output,c),"undefined"!==typeof d.path&&null!==d.path&&(b.m_promptInfoPath.textContent=d.path),"require-exit"===d.response&&(b.clearPromptInfo(),b.switchToPasswordInterface()),b.stopWaitingForResponse(),b.m_input.focus())},
a,a,null,{get_json:!0})}}};
